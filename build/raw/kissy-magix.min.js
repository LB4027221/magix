KISSY.add("magix/ajax",function(d,e,c){return c.implement({defaultOptions:{dataType:"html",success:function(){},failure:function(){}},send:c.unimpl,processOptions:function(a){a||(a={});for(var b in this.defaultOptions)a[b]||(a[b]=this.defaultOptions[b]);return a},getTemplate:function(a,b,f){var g=this,d;if(!g.$cache)g.$cache={};(d=g.$cache[a])?d.succ&&c.isFunction(b)?b(d.content):!d.succ&&c.isFunction(f)&&f(d.content):g.send({url:a,dataType:"html",success:function(f){g.$cache[a]={succ:!0,content:f};
c.isFunction(b)&&b(f)},failure:function(b){g.$cache[a]={content:b};c.isFunction(f)&&f(b)}})}},e)},{requires:["magix/impls/ajax","magix/base"]});
KISSY.add("magix/base",function(d,e){var c={mix:function(a,b,f,g){if(!b||!a)return a;void 0===f&&(f=!0);var c,d,e;if(g&&(e=g.length))for(c=0;c<e;c++){if(d=g[c],d in b&&(f||!(d in a)))a[d]=b[d]}else for(d in b)if(f||!(d in a))a[d]=b[d];return a},include:function(a){var a=Magix.config.magixHome+"../"+a+".js?r="+Math.random(),b=new (window.ActiveXObject||XMLHttpRequest)("Microsoft.XMLHTTP");b.open("GET",a,!1);b.send(null);return b.responseText},unimpl:function(){throw Error("unimplement method");}};
c.mix(c,{isFunction:c.unimpl,isArray:c.unimpl,isString:c.unimpl,isPlainObject:c.unimpl,requireAsync:c.unimpl,Events:c.unimpl,_idCounter:0,uniqueId:function(a){var b=this._idCounter++;return a?a+b:b},extend:function(a,b,f,c){if(!b||!a)return a;var d=Object.prototype,e=b.prototype,j=function(b){function a(){}a.prototype=b;return new a}(e);a.prototype=j;j.constructor=a;a.superclass=e;if(b!==Object&&e.constructor===d.constructor)e.constructor=b;f&&this.mix(j,f);c&&this.mix(a,c);return a},param:function(a){var b=
[],f;for(f in a)a.hasOwnProperty(f)&&b.push(f+"="+a[f]);return b.join("&")},unParam:function(a){for(var a=a.split("&"),b,f={},c=0;c<a.length;c++)b=a[c].split("="),b[0]&&(f[b[0]]=b[1]||"");return f},mixClassStaticProps:function(a,b){for(var f in b)b.hasOwnProperty(f)&&"prototype"!=f&&(a[f]=b[f]);return a},mixClassProtoProps:function(a,b){for(var f in b)if(!a[f]||a[f]==c.unimpl)a[f]=b[f];return a},implement:function(a,b){if(c.isFunction(a)&&c.isFunction(b)){b.prototype.constructor=b;var f=function(){b.apply(this,
arguments);a.apply(this,arguments);a.prototype.initial&&a.prototype.initial.apply(this,arguments);b.prototype.initial&&b.prototype.initial.apply(this,arguments)};this.mixClassStaticProps(f,a);this.mixClassStaticProps(f,b);this.mixClassProtoProps(f.prototype,a.prototype);this.mixClassProtoProps(f.prototype,b.prototype);return f.prototype.constructor=f}f={};c.mix(f,a);c.mix(f,b);return f}});c.mix(c,e);return c},{requires:["magix/impls/base"]});
KISSY.add("magix/impls/ajax",function(d,e){return{send:function(c){c=this.processOptions(c);e({url:c.url,dataType:c.dataType,success:function(a){c.success(a)},error:function(a){c.failure(a)}})}}},{requires:["ajax"]});
KISSY.add("magix/impls/base",function(d){var e=Object.prototype.toString;return{isFunction:d.isFunction,isArray:d.isArray,isString:d.isString,isPlainObject:function(c){return c&&"[object Object]"===e.call(c)&&!c.nodeType&&!c.setInterval},requireAsync:function(c,a){d.use(c,function(b,f){a(f)})},Events:{bind:function(c,a,b){var f=this._callbacks||(this._callbacks={});(f[c]||(f[c]=[])).push([a,b]);return this},unbind:function(c,a){var b;if(c){if(b=this._callbacks)if(a){b=b[c];if(!b)return this;for(var f=
0,g=b.length;f<g;f++)if(b[f]&&a===b[f][0]){b[f]=null;break}}else b[c]=[]}else this._callbacks={};return this},trigger:function(c){var a,b,f,g,d=2;if(!(b=this._callbacks))return this;for(;d--;)if(a=d?c:"all",a=b[a])for(var e=0,j=a.length;e<j;e++)(f=a[e])?(g=d?Array.prototype.slice.call(arguments,1):arguments,f[0].apply(f[1]||this,g)):(a.splice(e,1),e--,j--);return this}}}},{requires:["ajax"]});
KISSY.add("magix/impls/model",function(d,e,c){e=e.Model;d.mix(e.prototype,c.Events);var a=e.prototype.fire;e.prototype.fire=function(b,f){a(b,f);this.trigger(b,f)};return e},{requires:["mvc","magix/base"]});
KISSY.add("magix/impls/router",function(d,e,c,a,b,f){return{getAppConfig:function(){var b=f.pathViewMap,a=f.defaultViewName;if(a&&b)for(var c in b)b[c]||(b[c]=a);return f},setStateListener:function(){var a=this;(new b.Router).addRoutes({"*hash":function(b){d.log(b.hash);a.route(b.hash)}});b.Router.start({triggerRoute:1,urlRoot:location.href.split("#")[0].split("index.html")[0]})},parseState:function(b){return this._parseHash(b)},_parseHash:function(b){var a={},c;a.pathName=this.appConfig.indexPath;
a.paraObj={};a.referrer=this.state&&this.state.query||null;if(a.query=b)b=b.split("/"),c=b.pop(),a.pathName=b.join("/"),a.paraObj=e.unParam(c);return a},parseSearch:function(){return this._parseSearch()},_parseSearch:function(){var b={},a=this.config.pathPrefix||null;b.pathName=location.pathname;b.paraObj={};if(a)b.pathName=location.pathname.split(a)[1];b.query=b.pathName+location.search;if(location.search)b.paraObj=e.unParam(location.search.substr(1));return b},getRootViewName:function(){var b=this.appConfig.pathViewMap,
a;a=b[this.query.pathname]?b[this.query.pathname]:b[this.appConfig.notFoundPath];this.query.__view__&&(a=this.query.__view__.split("-").join("/"));if(this.config.multipage)b=b[this.query["sch:pathname"]],"object"==typeof b?a=b[this.query.pathname]||b[this.appConfig.notFoundPath]:(document.body.id="vc-root",a=b||this.appConfig.defaultRootViewName);return a},createQueryModel:function(){return new c(this.query)},changeQueryModel:function(){this._fixQueryModel(this.query);this.queryModel.set(this.query)},
_fixQueryModel:function(b){if(this.queryModel){var a,c=this.queryModel.toJSON();for(a in c)a in b||this.queryModel.unset(a,{silent:!0})}},mountRootView:function(){a.root.mountView(this.rootViewName,{queryModel:this.queryModel})}}},{requires:["magix/base","magix/model","magix/vom","mvc","app/config/ini"]});KISSY.add("magix/impls/template",function(d,e){return{toHTML:function(c){c=this.processOptions(c);return e(c.template).render(c.data)}}},{requires:["template"]});
KISSY.add("magix/impls/vframe",function(d,e,c){var a=function(){};e.mix(a,{tagName:"vframe"});e.mix(a.prototype,{getChildVframeNodes:function(){var b=document.getElementById(this.id).getElementsByTagName("vframe"),a,c=[];for(a=0;a<b.length;a++)c.push(this._idIt(b[a]));return c},getRouterObject:function(){return c},createFrame:function(){return document.createElement(a.tagName)}});return a},{requires:["magix/base","magix/router"]});
KISSY.add("magix/impls/view",function(d,e,c,a,b,f){var g=function(){g.superclass.constructor.apply(this,arguments)};d.extend(g,e.View,{initial:function(){this.delegateEvents()},getVOMObject:function(){return b},getAjaxObject:function(){return a},getTemplateObject:function(){return c},dispose:function(){g.superclass.destroy.apply(this,arguments)}});d.mix(g.prototype,f.Events);var r=g.prototype.fire;g.prototype.fire=function(b,a){r(b,a);this.trigger(b,a)};return g},{requires:["mvc","magix/template",
"magix/ajax","magix/vom","magix/base"]});KISSY.add("magix/impls/vom",function(){return{setRootVframe:function(){var d=null;if("vf-root"==document.body.id)d=document.body;var e=this.createElement(d,"vf-root");d||document.body.insertBefore(e.getOnce(),document.body.firstChild);this.root=e}}},{requires:["magix/base"]});
Magix={init:function(d){this.config=d||{};this.setEnv();this.bootstrap()},setEnv:function(){var d=this.config.appHome||"";KISSY.config({packages:[{name:"magix",path:(this.config.magixHome||"")+"../",tag:(new Date).getTime()},{name:"app",path:d+"../",tag:(new Date).getTime()}]})},bootstrap:function(){var d=this;KISSY.use("magix/router",function(e,c){e.log(c);c.init(d.config)})},implementBy:"kissy",version:"0.1.0",dev:""};
KISSY.add("magix/model",function(d,e,c){return c.implement(function(){},e)},{requires:["magix/impls/model","magix/base"]});if(!window.console)window.console={log:function(){},dir:function(){},warn:function(){},error:function(){}};
MxHistory={config:{},hash:"",oldHash:null,showIframe:!1,isIE:!1,iframe:null,slient:!1,interval:50,intervalId:0,iframeSrc:"",ready:!1,hashListener:null,currentHash:"",init:function(d){d=d||{};this.iframeSrc=d.iframeSrc||"mxhistory.html";this.config=d;this.oldHash=this.hash=location.hash;this.isIE=-1<navigator.userAgent.toLowerCase().indexOf("msie");d=document.documentMode;this.showIframe=this.isIE&&(!d||8>d);this.wirteFrame(this.iframeSrc);this.regHashChange();this.showIframe||this.route(this.hash)},
regHashChange:function(){var d=this;"onhashchange"in window&&!this.showIframe?window.onhashchange=function(){d.hashChange.call(d)}:this.intervalId=window.setInterval(function(){location.hash!=d.oldHash&&d.hashChange.call(d)},this.interval)},hashChange:function(){this.oldHash=this.hash=location.hash;this.showIframe?this.iframe.src=this.iframeSrc+"?"+(this.hash?this.hash.substr(1):""):this.route(this.hash)},frameLoad:function(){var d=Magix.History;if(d.iframe){var e=d.iframe.contentWindow.location.search.substr(1);
d.hash=d.oldHash="#"+e;location.hash=e}this.route(this.hash)},route:function(d){0===d.indexOf("?")&&(d=d.substr(1));0===d.indexOf("#")&&(d=d.substr(1));0===d.indexOf("!")&&(d=d.substr(1));this.hashListener&&this.hashListener(d);this.ready=!0;this.currentHash=d},wirteFrame:function(){var d=this;this.showIframe&&document.write("<iframe onload='Magix.History.frameLoad();' id='MxHistory' src='"+this.iframeSrc+"?"+(this.hash?this.hash.substr(1):"")+"' style='z-index:99998;visibility:hidden;position:absolute;' border='0' frameborder='0' marginwidth='0' marginheight='0' scrolling='no' ></iframe>");
window.setTimeout(function(){d.iframe=document.getElementById("MxHistory")},0)},setHashListener:function(d){this.hashListener=d;this.ready&&d(this.currentHash)}};
KISSY.add("magix/router",function(d,e,c){d={};c.mix(d,{config:null,appConfig:null,state:null,search:null,query:null,queryModel:null,rootViewName:null,oldRootViewName:null,postData:null,_locator:null,getAppConfig:c.unimpl,setStateListener:c.unimpl,parseState:c.unimpl,parseSearch:c.unimpl,getRootViewName:c.unimpl,createQueryModel:c.unimpl,changeQueryModel:c.unimpl,mountRootView:c.unimpl,navigateTo:c.unimpl,goTo:c.unimpl,setPostData:c.unimpl,init:function(a){this.config=a;this.appConfig=this.getAppConfig();
this.setStateListener()},route:function(a){this.state=this.parseState(a);this.search=this.parseSearch();this._locator={state:this.state,search:this.search};this.query=this._spreadLocator();this.oldRootViewName=this.rootViewName;this.rootViewName=this.getRootViewName();this.rootViewName==this.oldRootViewName?this.changeQueryModel():(this.queryModel=this.createQueryModel(),this.mountRootView());this.postData=null},_spreadLocator:function(){var a={},b=this._locator;c.mix(a,b.state.paraObj);c.mix(a,{referrer:b.state.referrer,
query:b.state.query,pathname:b.state.pathName,postdata:b.state.postData||null});var f={},d,e=b.search.paraObj;f["sch:pathname"]=b.search.pathName;f["sch:query"]=b.search.query;for(d in e)f["sch:"+d]=e[d];c.mix(a,f);return a}});c.mix(d,e);return d},{requires:["magix/impls/router","magix/base"]});
KISSY.add("magix/template",function(d,e,c){return c.implement({defaultOptions:{data:{},template:""},processOptions:function(a){for(var b in this.defaultOptions)a[b]||(a[b]=this.defaultOptions[b]);return a},toHTML:c.unimpl},e)},{requires:["magix/impls/template","magix/base"]});
KISSY.add("magix/vframe",function(d,e,c){var a;a=function(){};c.mix(a,{tagName:c.unimpl,uniqueId:function(){return c.uniqueId("vf-")},init:function(){document.createElement(this.tagName);return this}});c.mix(a.prototype,c.Events);c.mix(a.prototype,{getChildVframeNodes:c.unimpl,getRouterObject:c.unimpl,createFrame:c.unimpl,initial:function(b,a){this.id="";this.parentNode=null;this.childNodes=[];this.mounted=!1;this._domNode=b||this.createFrame();this.id=this._idIt(this._domNode,a);if(b)this._domNode=
null},_idIt:function(b,c){b.id=b&&b.id||c||a.uniqueId();return b.id},getOnce:function(){var b=this._domNode;this._domNode=null;return b},getAttribute:function(b){return document.getElementById(this.id).getAttribute(b)||""},setAttribute:function(b,a){return document.getElementById(this.id).setAttribute(b,a)},appendChild:function(b){this.childNodes.push(b);b.parentNode=this},getElements:function(){return this.getChildVframeNodes()},handelMounted:function(){this.view.rendered?(this.mounted=!0,this.trigger("mounted",
this.view)):this.view.bind("rendered",function(){this.mounted=!0;this.trigger("mounted",this.view)})},mountView:function(b,a){if(b){this.view&&this.view.destroy();var d=this,e=this.getRouterObject(),a=a||{};if(!a.queryModel)a.queryModel=e.queryModel;c.requireAsync(b,function(c){a.vcid=d.id;a.viewName=b;d.view=new c(a);d.handelMounted()})}},unmountView:function(){this.view.trigger("unload");document.getElementById(this.view.vcid).innerHTML="";if(this.view.events){var b=document.getElementById(this.id),
a;for(a in this.view.events)b["on"+a]=null}this.mounted=!1;this.view=null},removeNode:function(){this.mounted&&this.unmountView();this.trigger("unload");var b=document.getElementById(this.id);b&&(b.parentNode.removeChild(b),this.linkid&&(b=document.getElementById(this.linkid),b.parentNode.removeChild(b)));this.parentNode._removeChild(this)},_removeChild:function(b){var a,c,d=[];for(a=0;a<this.childNodes.length;a++)c=this.childNodes[a],c==b?this._popFromVOM(c):d.push(c);this.childNodes=d},_popFromVOM:function(b){c.requireAsync("magix/vom",
function(a){a.pop(b)})}});return c.implement(a,e).init()},{requires:["magix/impls/vframe","magix/base"]});
KISSY.add("magix/view",function(d,e,c){d=function(){};c.mix(d.prototype,{render:c.unimpl,getTemplate:c.unimpl,getVOMObject:c.unimpl,getTemplateObject:c.unimpl,getAjaxObject:c.unimpl,dispose:c.unimpl,queryModelChange:function(){},refresh:function(){},initial:function(a){var b=this,c=this.getVOMObject();this.subViewsChange=[];this.options=a;this.vcid=a.vcid;this.queryModel=a.queryModel;this.viewName=a.viewName;this.data=a.data||{};a.message&&"function"==typeof a.message&&this.bind("message",a.message);
this.exist=!0;this.bind("unload",function(){this.exist=!1});this.bind("rendered",function(){this.trigger("beforeSubviewsRender");var a=c.getElementById(this.vcid),b=a.getElements(),d,e;for(d=0;d<b.length;d++)e=c.createElement(b[d]),a.appendChild(e),e.mountView(e.getAttribute("view_name"),{queryModel:this.queryModel})});c.getElementById(this.vcid)==c.root&&this.queryModel.bind("change",function(){var a=b.queryModelChange(this);b._changeChain(a,this)});this.init&&this.init();this.getTemplate(function(a){b.template=
a;!1!==b.render()&&b.trigger("rendered")})},_queryModelChange:function(a){this._changeChain(this.queryModelChange(a),a)},_changeChain:function(a,b){var d=[],e;e=this.getVOMObject().getElementById(this.vcid);if(!1!==a){!0===a||void 0===a?d=e.childNodes:c.isArray(a)&&(d=a);for(e=0;e<d.length;e++)d[e].view&&d[e].view._queryModelChange(b)}},destory:function(){this.destroy()},destroy:function(){var a,b,c=this.getVOMObject();a=this.getDestoryQueue();for(b=a.length-1;0<b;b--)a[b].removeNode();c.getElementById(this.vcid).unmountView();
this.dispose()},getDestoryQueue:function(){function a(c){var d;b.push(c);for(d=0;d<c.childNodes.length;d++)a(c.childNodes[d])}var b=[],c=this.getVOMObject().getElementById(this.vcid);a(c);return b},setData:function(a){this.data=a;for(var b in a)a[b].toJSON&&(a[b]=a[b].toJSON());a.query=this.queryModel.toJSON();this.setRenderer()},setRenderer:function(){var a=this,b=this.renderer,c,d;if(b)for(c in b)for(d in b[c])(function(){var e=c,q=d,j=b[e][q];a.data[e+"_"+q]=function(){return j.call(this,a,e)}})()},
delegateEvents:function(){var a=this.events,b=this.eventsLevel,c=this.getVOMObject(),d=document.getElementById(this.options.vcid),e;for(e in a)(function(){var a=e,j="mx"+a;d["on"+a]=function(e){var e=e||window.event,h=e.target||e.srcElement;if(3===h.nodeType)h=h.parentNode;var k=h.getAttribute(j);if(b)var i=b[a];if(!k&&i)if(!isNaN(i)&&i)for(;i&&h!=d;){h=h.parentNode;if(k=h.getAttribute(j))break;i--}else if(i.split(".")[1])for(i=i.split(".")[1];h!=d;){if(h=h.parentNode,0<=h.className.indexOf(i)){k=
h.getAttribute(j);break}}else{if(i.split("#")[1])for(i=i.split("#")[1];h!=d;)if(h=h.parentNode,h.id==i){k=h.getAttribute(j);break}}else if(!k)h=h.parentNode,k=h.getAttribute(j);if(k)for(var i=k.split("|"),n,l=c.getElementById(this.id).view,o=0;o<i.length;o++){k=i[o].split(":");n=k.shift();var m=k[k.length-1],p=!1;if("_halt_"==m||"_preventDefault_"==m)e.preventDefault?e.preventDefault():e.returnValue=!1,p=!0;if("_halt_"==m||"_stop_"==m)e.stopPropagation?e.stopPropagation():e.cancelBubble=!0,p=!0;p&&
k.pop();if(l.events&&l.events[a]&&l.events[a][n])l.events[a][n](l,l.idIt(h),k)}}})()},render:function(){if(this.preventRender)return this.rendered=!0;var a=document.getElementById(this.vcid),b=this.getTemplateObject();a.innerHTML=b.toHTML({template:this.template,data:{data:this.data,queryModel:this.queryModel.toJSON()}});this.rendered=!0},getTemplate:function(a,b){if(this.preventRender)a();else{var c=Magix.config.appHome+this.viewName.split("app")[1];this.getAjaxObject().getTemplate(b?c+".name.html":
c+".html",function(b){a(b)},function(b){a(b)})}},idIt:function(a){var b="";if(!a.id)a.id=c.uniqueId("mxevt-");return b=a.id}});return c.implement(d,e)},{requires:["magix/impls/view","magix/base"]});
KISSY.add("magix/vom",function(d,e,c,a){d={};c.mix(d,{_idMap:{},root:null,setRootVframe:c.unimpl,init:function(){this.setRootVframe();return this},push:function(a){this._idMap[a.id]=a},pop:function(a){delete this._idMap[a.id]},createElement:function(b,d){c.isString(b)&&(b=document.getElementById(b));var e=new a(b,d);this.push(e);return e},getElementById:function(a){return this._idMap[a]||null}});c.mix(d,e);return d.init()},{requires:["magix/impls/vom","magix/base","magix/vframe"]});